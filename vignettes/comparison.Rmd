---
title: "Comparison of Pollen Traps"
subtitle: "Evaluation of Similarity and Robustness of Eight Pollen Traps Located in Payerne During the Blooming Season 2019"
author: "Simon Adamov"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
always_allow_html: TRUE
output:
  html_document:
    df_print: paged 
  pdf_document: default
  word_document: default
---

# Setup

This project is using renv dependency management, for more info: https://cran.r-project.org/web/packages/renv/vignettes/renv.html
The .RProfile is optimized for an interactive session in VSCode.

```{r }
knitr::opts_chunk$set(
  echo = FALSE,
  error = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.retina = 3,
  fig.width = 10,
  fig.height = 7,
  out.width = "100%",
  out.height = "100%"
)
# This project is using renv dependency management, for more info:
# https://cran.r-project.org/web/packages/renv/vignettes/renv.html

library(caTools)
library(httpgd)
library(languageserver)
library(MASS)
library(tidyverse)
library(magrittr)
library(lubridate)
library(ggpubr)
library(here)
library(kableExtra)
library(ggthemr)

# library(AeRobiology)
# library(lme4)
# library(psych)
# library(robustlmm)
# library(nparcomp)
# library(goftest)

library(conflicted)
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("extract", "magrittr")

# Some functions are used from these packages
# missmap from library(Amelia)
# transpose from library(data.table)
# statistical test from library(dunn.test)
# statistical test from library(conover.test)

devtools::load_all()
# I like the look of these plots: cttobin/ggthemr
ggthemr("fresh")

# Due to old R-Version some packages must be installed from CRAN Archive,
# in order to knit markdown documents.
# caTools@1.17.1.1
# pbkrtest@0.4-7
# nloptr@1.2.2
# foreign@0.8-76
# devtools@2.2.1
# usethis@1.5.1
# devtools@2.2.1
```

# Data Import

The data was prepared by Fiona Tummon and stored in the /data-raw Folder.
Eight different Pollen Traps were situated on the roof in Payerne and continously measured pollen grains between 19.04.2019 - 31.05.2019.
For the sake of simplicity we only look at concentrations of total pollen (i.e. the sum of all pollen taxa).
The concentrations were temporally averaged to obtain three different timeseries:

- Hourly averages
- 6-hour averages (hourly values from 00:00 to 05:00, 06:00 to 11:00, ...)
- Daily averages (hourly values from 00:00 to 23:00)

The preprocessed data is available to the reader in the /data folder. In /data-raw/preproc.R the preprocessing is documented.
The data has no missing except for the hourly Poleno timeseries, where calibration was carried out on 6 days in March.
These six days were excluded from the analysis.

The following eight traps are being compared:

- Hirst 1
- Hirst 2
- Hund (only daily values)
- KH-A
- KH-B
- Poleno
- Rapide
- WIBS (only daily values)


```{r }
load(paste0(here(), "/data/pollen.rda"))
aggregation <- c("daily", "sixhourly", "hourly")
map(aggregation, ~ pollen %>% extract2(.x))
```

The number of traps measuring decreases with higher temporal resolution.

```{r }
number_of_measurements <- map(pollen, ~ .x %>%
  group_by(trap, date, hour) %>%
  mutate(ntraps = as.integer(as.integer(conc) != 0)) %>%
  ungroup() %>%
  group_by(date, hour) %>%
  summarise(ntraps = sum(ntraps)) %>%
  ungroup() %>%
  mutate(ntraps = factor(ntraps)))

timesteps <- map(number_of_measurements, ~ .x %>% nrow())

pmap(
  list(number_of_measurements, aggregation, c(8, 6, 6)),
  function(first, second, third) {
    first %>%
      count(ntraps) %>%
      mutate(
        freq = scales::percent(n / nrow(first), accuracy = 0.1),
        res = second,
        tottraps = paste0(ntraps, " / ", third)
      )
  }
) %>%
  bind_rows() %>%
  select(
    "Temporal Resolution" = res,
    "Number of Traps Measuring" = tottraps,
    "Frequency of Occurence" = freq
  ) %>%
  kable(full.escape = FALSE) %>%
  kable_styling("striped", full_width = FALSE) %>%
  column_spec(1, border_right = TRUE) %>%
  collapse_rows(columns = 1) %>%
  pack_rows(NULL, 1, 2, indent = FALSE) %>%
  pack_rows(NULL, 3, 6, indent = FALSE) %>%
  pack_rows(NULL, 7, 11, indent = FALSE)
```
