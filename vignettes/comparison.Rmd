---
title: "Comparison of Pollen Traps"
subtitle: "Evaluation of Similarity and Robustness of Eight Pollen Traps Located in Payerne During the Blooming Season 2019"
author: "Simon Adamov"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
always_allow_html: TRUE
output:
  html_document:
    df_print: paged 
  pdf_document: default
  word_document: default
---

# Setup

This project is using renv dependency management, for more info: https://cran.r-project.org/web/packages/renv/vignettes/renv.html
The .RProfile is optimized for an interactive session in VSCode.

```{r setup}
knitr::opts_chunk$set(
  echo = FALSE,
  error = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.retina = 3,
  fig.width = 10,
  fig.height = 7,
  out.width = "100%",
  out.height = "100%"
)
# This project is using renv dependency management, for more info:
# https://cran.r-project.org/web/packages/renv/vignettes/renv.html

library(caTools)
library(httpgd)
library(languageserver)
library(MASS)
library(tidyverse)
library(magrittr)
library(lubridate)
library(ggpubr)
library(here)
library(kableExtra)
library(ggthemr)

# library(AeRobiology)
# library(lme4)
# library(psych)
# library(robustlmm)
# library(nparcomp)
# library(goftest)

library(conflicted)
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("extract", "magrittr")

# Some functions are used from these packages
# missmap from library(Amelia)
# transpose from library(data.table)
# statistical test from library(dunn.test)
# statistical test from library(conover.test)

devtools::load_all()
# I like the look of these plots: cttobin/ggthemr
ggthemr("fresh")

# Due to old R-Version some packages must be installed from CRAN Archive,
# in order to knit markdown documents.
# caTools@1.17.1.1
# pbkrtest@0.4-7
# nloptr@1.2.2
# foreign@0.8-76
# devtools@2.2.1
# usethis@1.5.1
# devtools@2.2.1
```

# Data Import

The data was prepared by Fiona Tummon and stored in the /data-raw Folder.
Eight different Pollen Traps were situated on the roof in Payerne and continously measured pollen grains between 19.04.2019 - 31.05.2019.
For the sake of simplicity we only look at concentrations of total pollen (i.e. the sum of all pollen taxa).
The concentrations were temporally averaged to obtain three different timeseries:

- Hourly averages
- 6-hour averages (hourly values from 00:00 to 05:00, 06:00 to 11:00, ...)
- Daily averages (hourly values from 00:00 to 23:00)

The preprocessed data is available to the reader in the /data folder. In /data-raw/preproc.R the preprocessing is documented.
The data has no missing except for the hourly Poleno timeseries, where calibration was carried out on 6 days in March.
These six days were excluded from the analysis.

The following eight traps are being compared:

- Hirst 1
- Hirst 2
- Hund (only daily values)
- KH-A
- KH-B
- Poleno
- Rapide
- WIBS (only daily values)


```{r data}
load(paste0(here(), "/data/pollen.rda"))
aggregation <- c("daily", "sixhourly", "hourly")
map(aggregation, ~ pollen %>% extract2(.x))
```

# Comparison

## Some Easy Tables

The number of traps measuring decreases with higher temporal resolution.

```{r ntraps}
number_of_measurements <- map(pollen, ~ .x %>%
  group_by(trap, date, hour) %>%
  mutate(ntraps = as.integer(as.integer(conc) != 0)) %>%
  ungroup() %>%
  group_by(date, hour) %>%
  summarise(ntraps = sum(ntraps)) %>%
  ungroup() %>%
  mutate(ntraps = factor(ntraps)))

timesteps <- map(number_of_measurements, ~ .x %>% nrow())

kable_ntraps <- pmap(
  list(number_of_measurements, aggregation, c(8, 6, 6)),
  function(first, second, third) {
    first %>%
      count(ntraps) %>%
      mutate(
        freq = scales::percent(n / nrow(first), accuracy = 0.1),
        res = second,
        tottraps = paste0(ntraps, " / ", third)
      )
  }
) %>%
  bind_rows() %>%
  select(
    "Temporal Resolution" = res,
    "Number of Traps Measuring" = tottraps,
    "Frequency of Occurence" = freq
  ) %>%
  kable(full.escape = FALSE) %>%
  kable_styling("striped", full_width = FALSE) %>%
  column_spec(1, border_right = TRUE) %>%
  collapse_rows(columns = 1) %>%
  pack_rows(NULL, 1, 1, indent = FALSE) %>%
  pack_rows(NULL, 2, 5, indent = FALSE) %>%
  pack_rows(NULL, 6, 10, indent = FALSE)
  
kable_ntraps
```

In the following when we look at measurements from traps, we simply average between the four counted lines.
Several metrics were calculated: the frequency of occurrence for each pollen was obtained by counting the number of days that each particular pollen was detected; 
the seasonal mean was calculated by averaging values for each pollen for all the days that it occurred; 
and the Seasonal Pollen Integral (SPI) was calculated by integrating the concentrations of a particular pollen over the entire season (Mandrioli et al., 1998).

These metrics are well-known and usually part of a Pollen Measurement study. It is common investigate individual pollen species during their the blooming. 
Here we are calculating them for total pollen, which might not be as meaningful, but can function as a crude mechanism of comparison.

```{r tables}
pol_occurence <- pollen$daily %>%
  group_by(trap) %>%
  summarise(occurence = sum(conc != 0)) %>%
  ungroup()

pol_maximum <- pollen$daily %>%
  group_by(trap) %>%
  summarise(maximum = max(conc)) %>%
  ungroup()

pol_average <- pollen$daily %>%
  group_by(trap) %>%
  summarise(average = mean(conc)) %>%
  ungroup()
  
pol_median <- pollen$daily %>%
  group_by(trap) %>%
  summarise(median = median(conc)) %>%
  ungroup()

pol_spi <- pollen$daily %>% # Seasonal Pollen Integral
  group_by(trap) %>%
  summarise(spi = sum(conc)) %>%
  ungroup()

kable_metrics <- pol_occurence %>%
  inner_join(pol_maximum, by = "trap") %>%
  inner_join(pol_average, by = "trap") %>%
  inner_join(pol_median, by = "trap") %>%
  inner_join(pol_spi, by = "trap") %>%
  mutate_if(is.numeric, ~round(.)) %>%
  kable(escape = FALSE) %>%
  kable_styling(c("striped", "condensed"), full_width = FALSE, font_size = 20) %>%
  column_spec(1, italic = TRUE, border_right = TRUE)

kable_metrics

```

We can see that already for daily values the differences between traps are substantial.

